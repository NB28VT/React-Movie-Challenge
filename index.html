<html>
  <head>
    <meta charset="utf-8">
    <title>Movie Game</title>
    <!-- Script tags including React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.1/react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.1/react-dom.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css">
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" /> -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  </head>
  <body>
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">MovieMatcher5000</a>
      </div>
    </nav>


    <div class="container-fluid">
      <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10 app" id="app"></div>
        <div class="col-md-1"></div>
      </div>
    </div>
    <!--Future: break into separate files and run on webserver -->
    <!-- https://stackoverflow.com/questions/30200028/react-component-in-seperate-script-does-not-work -->
    <!-- <script src="Components.js" type="text/babel"></script> -->
    <script src="config.js" type="text/javascript"></script>
    <script type="text/babel">

      class App extends React.Component {
        render() {
          return (
            // TODO: SEARCH FEATURE
            <GameBoard movieUrl={"https://api.themoviedb.org/3/movie/1891?api_key=" + config.TMDB_V3_KEY}
              actorUrl={"https://api.themoviedb.org/3/movie/1891/credits?api_key=" + config.TMDB_V3_KEY}
            />

          )
        }
      }

      class GameBoard extends React.Component {
        constructor(props){
          super(props);
          this.state = {
            movieData: [],
            cast: [],
            scrambledCast: [],
            selections: {}
          }
        }

        componentDidMount(){
          this.getMovie();
          this.getCast();
        }

        handleCorrectAnswer(castId) {
          const selections = this.state.selections;
          selections[castId] = true;
          this.setState({selections: selections});
          // Move to component did update, possibly..
          this.checkAnswers();
        }

        checkAnswers() {
          if ( Object.values(this.state.selections).every(answer => answer === true) ) {
            alert("You are winnah! Hahaha");
          }
        }

        componentDidUpdate(){
          // Check if the game has been won here
        }

        buildSelections(castList) {
          var selections = {};
          castList.forEach(function(castMember){
            selections[castMember.id] = false;
          })
          return selections;
        }

        getCast(actorName) {
          $.ajax({
            url: this.props.actorUrl,
            type: "get",
            dataType: "JSONP",
            success: function(data) {

              const castList = data.cast.slice(0,5);
              this.setState({
                cast: castList,
                // Using same var shuffles cast list MUTABILITY
                scrambledCast: this.shuffleCast(data.cast.slice(0,5)),
                selections: this.buildSelections(castList)
              });
            }.bind(this),
            error: function(xhr, status, error){
              console.log(error);
            }.bind(this)
          })
        }

        getMovie(){
          $.ajax({
            url: this.props.movieUrl,
            type: "get",
            dataType: "JSONP",
            success: function(data) {
              this.setState({movieData: data});
            }.bind(this),
            error: function(xhr, status, error){
              console.log(error);
            }.bind(this)
          })
        }

        shuffleCast(castMembers){
            // Fisher-Yates shuffle
            var remainingCount = castMembers.length, top, index;
            while(remainingCount) {
              // Pick a random remaining element
              index = Math.floor(Math.random() * remainingCount--);
              // Swap it with the current element
              top = castMembers[remainingCount];
              castMembers[remainingCount] = castMembers[index];
              castMembers[index] = top;
            }
            return castMembers;
        }

        render(){
          const cast = this.state.cast;
          const scrambledCast = this.state.scrambledCast;
          return(
              <div className="gameBoard">
                <div className="movieTitle">
                  <h1>{this.state.movieData.title}</h1>
                </div>
                <div className="castRow">
                  {cast.map((castMember) => (
                    <div className="castMember">
                      <CastMember handleCorrectAnswer={this.handleCorrectAnswer.bind(this)} thumbnailUrl={castMember.profile_path} memberId={castMember.id} scrambledCast={scrambledCast}/>
                    </div>
                  ))}
                </div>
              </div>
          )
        }
      }

      class CastMember extends React.Component {
        handleNameSelection(value) {
          // Bug! if wrong set value to false
          if (parseInt(value) === this.props.memberId) {
            this.props.handleCorrectAnswer(this.props.memberId);
          }
        }

        render(){
          const thumbnailUrl = "https://image.tmdb.org/t/p/w500" +  this.props.thumbnailUrl + "?api_key=" + config.TMDB_V3_KEY;
          const scrambledCast = this.props.scrambledCast;


          return(
            <div>
              <img className="castThumbnail" src={thumbnailUrl}/>
              <NameSelector  onNameSelection={this.handleNameSelection.bind(this)} scrambledCast={scrambledCast} />
            </div>
          )
        }
      }

      // TODO: Rewrite as a functional component?
      // https://reactjs.org/tutorial/tutorial.html#functional-components
      class NameSelector extends React.Component {
        handleSelection(event) {
          this.props.onNameSelection(event.target.value);
        }

        render(){
          const scrambledCast = this.props.scrambledCast;

          // TODO: React Boostrap buttons?
          // https://react-bootstrap.github.io/introduction.html
          return(
            <select onChange={this.handleSelection.bind(this)} className="nameSelector">
              <option>Select Name</option>
              {scrambledCast.map((castMember) => (
                <option value={castMember.id}>{castMember.name}</option>
              ))}
            </select>
          )
        }
      }

      var mount = document.querySelector('#app');
      ReactDOM.render(<App />, mount);
    </script>
  </body>
</html>
